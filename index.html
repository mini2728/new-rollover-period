<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è½‰å€‰è¨­å®šç®¡ç†ç³»çµ±</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg-body: #f1f5f9;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --danger: #ef4444;
      --success: #10b981;
      --radius: 8px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      padding: 40px 20px;
      margin: 0;
      line-height: 1.5;
    }

    /* ç‰ˆé¢å®¹å™¨ */
    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    /* å¡ç‰‡å…±ç”¨æ¨£å¼ */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 32px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      position: relative;
      transition: transform 0.2s ease;
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 24px;
      font-size: 22px;
      font-weight: 600;
      color: #0f172a;
      border-bottom: 1px solid var(--border);
      padding-bottom: 16px;
    }

    /* è¡¨å–®å…ƒç´  */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
      color: #334155;
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="date"],
    input[type="time"],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background-color: #fff;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
      color: var(--text-main);
      height: 42px; /* å›ºå®šé«˜åº¦ */
    }

    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Checkbox */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    .checkbox-row input {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .checkbox-row span {
      font-size: 14px;
      color: var(--text-muted);
      cursor: pointer;
    }

    /* æŒ‰éˆ• */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 24px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      width: 100%;
    }
    .btn-primary:hover {
      background: var(--primary-hover);
    }
    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    
    .btn-action {
      padding: 6px 12px;
      font-size: 13px;
      height: 38px;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }
    .btn-outline:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }
    .btn-danger {
      background: #fee2e2;
      color: #991b1b;
    }
    .btn-danger:hover {
      background: #fecaca;
    }

    /* é€£çµæ¨£å¼ */
    .link-styled {
      color: var(--primary);
      text-decoration: none;
      font-size: 13px;
      margin-left: 8px;
    }
    .link-styled:hover {
      text-decoration: underline;
    }

    /* è¨Šæ¯æç¤º */
    #loginMessage {
      font-size: 14px;
      margin-top: 12px;
      text-align: center;
      min-height: 20px;
      padding: 8px;
      border-radius: var(--radius);
    }
    #loginMessage.success { background: #dcfce7; color: #166534; }
    #loginMessage.error   { background: #fee2e2; color: #991b1b; }

    /* é–å®šé®ç½© (Glassmorphism) */
    .locked {
      pointer-events: none;
      user-select: none;
      position: relative;
      overflow: hidden; /* é˜²æ­¢æ¨¡ç³Šæº¢å‡º */
    }
    .locked::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(4px);
      z-index: 10;
    }
    .locked::after {
      content: "ğŸ”’ è«‹å…ˆç™»å…¥ä»¥è§£é–æ­¤åŠŸèƒ½";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 12px 24px;
      border-radius: 99px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      font-weight: 600;
      color: #475569;
      z-index: 11;
      border: 1px solid var(--border);
    }

    /* Grid Layout for Settings */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* è½‰å€‰åˆ—è¡¨ Header */
    .rollover-header {
      display: grid;
      grid-template-columns: 1.7fr 2fr 1.5fr 120px; /* æœˆä»½ | æ—¥æœŸ | æ™‚é–“ | æ“ä½œ */
      gap: 12px;
      padding: 10px 16px;
      background: #f8fafc;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* è½‰å€‰åˆ—è¡¨ Row */
    .rollover-row {
      display: grid;
      grid-template-columns: 1.7fr 2fr 1.5fr 120px;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      padding: 0 4px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Select2 Customization to match theme */
    .select2-container { width: 100% !important; }
    .select2-container .select2-selection--single {
      height: 42px !important;
      border: 1px solid var(--border) !important;
      border-radius: var(--radius) !important;
      padding: 6px !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 28px !important;
      color: var(--text-main) !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 40px !important;
    }
    .select2-container--focus .select2-selection--single {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Divider */
    hr {
      border: 0;
      height: 1px;
      background: var(--border);
      margin: 30px 0;
    }
    
    .section-title {
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* æ—¢æœ‰è½‰å€‰æ’ç¨‹è¡¨æ ¼ */
    #existingRollovers {
      font-size: 13px;
      color: var(--text-main);
    }
    .rollover-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .rollover-table th,
    .rollover-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 13px;
    }
    .rollover-table th {
      background: #f8fafc;
      color: var(--text-muted);
      font-weight: 600;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal.show {
      display: flex;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
    }
    .modal-content {
      position: relative;
      background: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow);
      max-width: 700px;
      width: 100%;
      padding: 24px 24px 20px;
      z-index: 1000;
      max-height: 80vh;
      overflow: auto;
    }
    .modal-content h3 {
      margin: 0 0 12px;
      font-size: 18px;
      font-weight: 600;
      color: #0f172a;
    }
    .modal-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .modal-actions {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* é è¦½è¡¨æ ¼ */
    #schedulePreview table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
    }
    #schedulePreview th,
    #schedulePreview td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 13px;
    }
    #schedulePreview th {
      background: #f8fafc;
      color: var(--text-muted);
      font-weight: 600;
    }

    /* æäº¤çµæœ log */
    #submitLog {
      margin-top: 8px;
      font-size: 13px;
      white-space: pre-line;
      color: #0f172a;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f8fafc;
      border: 1px solid var(--border);
      max-height: 200px;
      overflow-y: auto;
    }
    #submitLog div {
      margin-bottom: 4px;
    }
  </style>

  <!-- axios CDN -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body>

<div class="container">

  <!-- ç™»å…¥å¡ç‰‡ -->
  <div class="card">
    <h2>æ–°å¢å¹´åº¦è½‰å€‰é€±æœŸ V2.0</h2>

    <div class="form-group">
      <label for="loginEmail">å¸³è™Ÿ</label>
      <input type="email" id="loginEmail" />
    </div>

    <div class="form-group">
      <label for="loginPassword">å¯†ç¢¼</label>
      <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    </div>

    <div class="checkbox-row">
      <label style="display:flex; align-items:center; cursor:pointer; margin:0;">
        <input type="checkbox" id="rememberLogin" />
        <span style="margin-left:8px;">è¨˜ä½ç™»å…¥è³‡è¨Š</span>
      </label>
    </div>

    <button id="loginButton" class="btn btn-primary">ç«‹å³ç™»å…¥</button>
    <div id="loginMessage"></div>
  </div>

  <!-- è½‰å€‰è¨­å®šå¡ç‰‡ -->
  <div class="card locked" id="featureCard">
    <h2>âš™ï¸ è½‰å€‰æ’ç¨‹è¨­å®š</h2>

    <!-- ç¬¬ä¸€åˆ—ï¼šå•†å“èˆ‡å¹´ä»½ -->
    <div class="grid-2">
      <div class="form-group">
        <label for="symbolSelect">é¸æ“‡å•†å“</label>
        <select id="symbolSelect">
          <option value="">è«‹å…ˆç™»å…¥è¼‰å…¥æ¸…å–®</option>
        </select>
        <input type="hidden" id="symbolId" />
        <input type="hidden" id="exchange" />
        <input type="hidden" id="symbol" />
      </div>

      <div class="form-group">
        <label for="yearSelect">é¸æ“‡å¹´ä»½</label>
        <select id="yearSelect"></select>
      </div>
    </div>

    <!-- ç¬¬äºŒåˆ—ï¼šé€±æœŸ -->
    <div class="form-group">
      <label for="cycleSelect">
        è½‰å€‰é€±æœŸ (æœˆ)
        <a href="https://docs.google.com/spreadsheets/d/1NcraFH_stAucP-J51R0iW9BquIJB5k0MXQ5b0bfIluQ/edit?pli=1#gid=228871678"
           target="_blank" class="link-styled">
           (æ‰¾ä¸åˆ°é€±æœŸï¼Ÿé»æ­¤æ–°å¢)
        </a>
      </label>
      <select id="cycleSelect">
        <option value="">è«‹å…ˆç™»å…¥è¼‰å…¥é€±æœŸ</option>
      </select>
    </div>

    <hr>

    <div class="section-title">
      <span>ğŸ“… è½‰å€‰æœˆä»½èˆ‡æ™‚é–“è¨­å®š</span>
    </div>

    <!-- è¡¨é ­ (Header) -->
    <div class="rollover-header">
      <div>å•†å“æœˆä»½</div>
      <div>è½‰å€‰æ—¥æœŸ</div>
      <div>è½‰å€‰æ™‚é–“ (+0800)</div>
      <div>æ“ä½œ</div>
    </div>

    <!-- å‹•æ…‹ç”Ÿæˆå€åŸŸ -->
    <div id="rolloverContainer"></div>

    <hr>

    <!-- â¬‡â¬‡ é€™é‚Šæ˜¯ä½ è¦æ±‚æ”¹æˆã€Œæ–°å¢è½‰å€‰é€±æœŸã€ + log â¬‡â¬‡ -->
    <div class="section-title">
      <button type="button" class="btn btn-primary btn-action" onclick="openScheduleModal()">æ–°å¢è½‰å€‰é€±æœŸ</button>
    </div>

    <div id="submitLog">// æ¯ä¸€ç­† API å‚³é€çµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
    <!-- â¬†â¬† é€™æ®µå–ä»£åŸæœ¬ JSON è¼¸å‡ºå€å¡Š â¬†â¬† -->

    <hr>

    <div class="section-title">
      <span>ğŸ“œ æ—¢æœ‰è½‰å€‰æ’ç¨‹ (å¾ä¼ºæœå™¨è¼‰å…¥)</span>
    </div>
    <div id="existingRollovers">// è«‹å…ˆé¸æ“‡å•†å“ä»¥è¼‰å…¥æ—¢æœ‰æ’ç¨‹</div>

  </div>

</div>

<!-- Modalï¼šç¢ºèªå³å°‡é€å‡ºçš„è½‰å€‰é€±æœŸ -->
<div id="scheduleModal" class="modal">
  <div class="modal-backdrop" onclick="closeScheduleModal()"></div>
  <div class="modal-content">
    <h3>ç¢ºèªè½‰å€‰æ’ç¨‹</h3>
    <div class="modal-subtitle">
      è«‹ç¢ºèªä»¥ä¸‹è½‰å€‰é€±æœŸæ˜¯å¦æ­£ç¢ºï¼Œç¢ºèªå¾Œæœƒä¾åºå‘¼å« API æ–°å¢ï¼š
      <code>/api/admin/v3/futures-symbols/{å•†å“ID}/rollovers</code>
    </div>
    <div id="schedulePreview">
      <!-- é è¦½è¡¨æ ¼æœƒç”± JS å‹•æ…‹æ’å…¥ -->
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-outline btn-action" onclick="closeScheduleModal()">å–æ¶ˆ</button>
      <button type="button" class="btn btn-primary btn-action" onclick="submitRollovers()">ç¢ºèªé€å‡º</button>
    </div>
  </div>
</div>

<script>
  // ========== å¸¸æ•¸ / DOM ==========
  const LOGIN_API   = "https://console.stranity.org/api/public/user/login";
  const SYMBOL_API  = "https://console.stranity.org/api/admin/v3/futures-symbols";
  const CYCLE_API   = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLha6OuaII7H7ka6LGVzqIYWC2E7R-1P2qT_sLLM_W-TK-ZcCixwhFbu6aDbKRzJQap9kFK53FIlIx-gmfRKrhuruttnMRQ1_Y91EDAac9Z_oXVqDcHQ0iBklsxfErEJrdezhJajNJu4wifzdQah_zjyEnduqeJ45VbW6lVwsG-tgU5S18Q8xRqecWF3jC8Lkrga0sDr-2NgxDGu7c_a36-N8KQ12qf0ISVCJTVYUDFHahfgEob5x-dP3LwIXXmdZCQItu766a7o02vXaLkWsc1OI5GbeQ&lib=MG8XmPR3E24yCM7_Xma50bTHhSIBa6JR9";
  const ROLLOVER_API_BASE = "https://console.stranity.org/api/admin/v3/futures-symbols";

  const cycleSelect   = document.getElementById("cycleSelect");
  const container     = document.getElementById("rolloverContainer");
  const yearSelect    = document.getElementById("yearSelect");
  const loginEmail    = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const rememberLogin = document.getElementById("rememberLogin");
  const loginButton   = document.getElementById("loginButton");
  const loginMessage  = document.getElementById("loginMessage");
  const featureCard   = document.getElementById("featureCard");
  const existingRollovers = document.getElementById("existingRollovers");
  const scheduleModal = document.getElementById("scheduleModal");
  const schedulePreview = document.getElementById("schedulePreview");
  const submitLog = document.getElementById("submitLog");

  let isLoggedIn = false;
  let isSubmitting = false;
  let currentCycleMonths = [];
  let currentBuiltSchedules = []; // â­ å­˜ modal è£¡è¦é€å‡ºçš„è³‡æ–™

  // ========== åˆå§‹åŒ– ==========
  document.addEventListener("DOMContentLoaded", () => {
    initYearOptions();
    restoreLoginFromLocalStorage();
  });

  // ========== å¹´ä»½ï¼šä»Šå¹´ Â± 2 å¹´ ==========
  function initYearOptions() {
    const currentYear = new Date().getFullYear();
    yearSelect.innerHTML = "";
    for (let y = currentYear - 2; y <= currentYear + 2; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      if (y === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }
  }

  // ========== åŠŸèƒ½å¡ç‰‡é–å®š / è§£é– ==========
  function setFeatureLocked(locked) {
    if (locked) {
      featureCard.classList.add("locked");
    } else {
      featureCard.classList.remove("locked");
    }
  }

  // ========== ç™»å…¥ç›¸é—œ ==========
  function restoreLoginFromLocalStorage() {
    const savedRemember = localStorage.getItem("str_remember_login") === "true";
    rememberLogin.checked = savedRemember;

    if (savedRemember) {
      const savedEmail = localStorage.getItem("str_admin_email") || "";
      const savedPwd   = localStorage.getItem("str_admin_password") || "";
      loginEmail.value = savedEmail;
      loginPassword.value = savedPwd;
    }
  }

  async function handleLogin() {
    const email = loginEmail.value.trim();
    const pwd   = loginPassword.value;

    loginMessage.textContent = "";
    loginMessage.className = "";

    if (!email || !pwd) {
      loginMessage.textContent = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼";
      loginMessage.classList.add("error");
      return;
    }

    loginButton.disabled = true;
    loginButton.textContent = "ç™»å…¥ä¸­â€¦";

    try {
      const res = await axios.post(LOGIN_API, {
        email: email,
        account: email,
        password: pwd
      });

      const data = res.data || {};
      const successFlag = data?.error?.success;

      if (!successFlag) throw new Error("API returned success = false");

      let token = data.result?.accessToken || data.accessToken || data.token || data.data?.accessToken;
      if (!token) throw new Error("ç„¡æ•ˆçš„ Token");

      localStorage.setItem("str_access_token", token);

      if (rememberLogin.checked) {
        localStorage.setItem("str_admin_email", email);
        localStorage.setItem("str_admin_password", pwd);
        localStorage.setItem("str_remember_login", "true");
      } else {
        localStorage.removeItem("str_admin_email");
        localStorage.removeItem("str_admin_password");
        localStorage.setItem("str_remember_login", "false");
      }

      isLoggedIn = true;
      setFeatureLocked(false);

      loginMessage.className = "success";
      loginMessage.textContent = "ç™»å…¥æˆåŠŸï¼";

      loadCycles();
      loadSymbolList();
    } catch (err) {
      console.error("Login Error", err);
      isLoggedIn = false;
      setFeatureLocked(true);
      loginMessage.className = "error";
      loginMessage.textContent = "ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³å¯†ã€‚";
    } finally {
      loginButton.disabled = false;
      loginButton.textContent = "ç«‹å³ç™»å…¥";
    }
  }

  loginButton.addEventListener("click", handleLogin);

  // ========== è¼‰å…¥å•†å“æ¸…å–® ==========
  async function loadSymbolList() {
    const token = localStorage.getItem("str_access_token");
    if (!token) return;

    try {
      const res = await axios.get(SYMBOL_API, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.data?.error?.success) {
        console.error("Load Symbols Failed");
        return;
      }

      const list = res.data.result || [];
      const options = list.map(item => ({
        id: String(item.id),  
        text: `${item.exchange} ${item.symbol}`,
        exchange: item.exchange,
        symbol: item.symbol
      }));

      const $select = $("#symbolSelect");
      if ($select.hasClass("select2-hidden-accessible")) {
        $select.select2("destroy");
      }

      $select.empty();
      $select.select2({
        data: options,
        placeholder: "ğŸ” æœå°‹å•†å“ï¼ˆè¼¸å…¥é—œéµå­—ï¼‰",
        allowClear: true,
        width: '100%'
      });

      $select.val(null).trigger("change");

      $select.on("select2:select", function (e) {
        const selected = e.params.data;
        document.getElementById("symbolId").value = selected.id;
        document.getElementById("exchange").value = selected.exchange;
        document.getElementById("symbol").value = selected.symbol;

        loadExistingRollovers(selected.id, selected.symbol);
      }).on("select2:clear", function () {
        document.getElementById("symbolId").value = "";
        document.getElementById("exchange").value = "";
        document.getElementById("symbol").value = "";
        existingRollovers.textContent = "// è«‹å…ˆé¸æ“‡å•†å“ä»¥è¼‰å…¥æ—¢æœ‰æ’ç¨‹";
      });

    } catch (err) {
      console.error("Load Symbols Error", err);
    }
  }

  // ========== è¼‰å…¥é€±æœŸ ==========
  async function loadCycles() {
    try {
      const res = await axios.get(CYCLE_API);
      let raw = res.data;
      let rows = (typeof raw === "string") ? JSON.parse(raw) : raw;

      let dataRows = [];
      if (Array.isArray(rows)) dataRows = rows;
      else if (rows?.values) dataRows = rows.values;
      else if (rows?.rows) dataRows = rows.rows;

      const normalized = dataRows
        .map(row => Array.isArray(row) ? row.join(",") : String(row))
        .map(r => r.trim())
        .filter(r => r !== "");
      
      fillCycleSelect(normalized);
    } catch (err) {
      console.error("Load Cycles Error", err);
      cycleSelect.innerHTML = "<option value=''>è¼‰å…¥é€±æœŸå¤±æ•—</option>";
    }
  }

  function fillCycleSelect(rows) {
    cycleSelect.innerHTML = "";
    const defaultOpt = document.createElement("option");
    defaultOpt.value = "";
    defaultOpt.textContent = "è«‹é¸æ“‡è½‰å€‰é€±æœŸ...";
    cycleSelect.appendChild(defaultOpt);

    rows.forEach(row => {
      const clean = row.replace(/\s+/g, "");
      const opt = document.createElement("option");
      opt.value = clean;
      opt.textContent = clean;
      cycleSelect.appendChild(opt);
    });
  }

  // ========== è½‰å€‰é€±æœŸ / æœˆä»½ ==========
  const monthMap = {
    '01æœˆ': 'F', '02æœˆ': 'G', '03æœˆ': 'H', '04æœˆ': 'J',
    '05æœˆ': 'K', '06æœˆ': 'M', '07æœˆ': 'N', '08æœˆ': 'Q',
    '09æœˆ': 'U', '10æœˆ': 'V', '11æœˆ': 'X', '12æœˆ': 'Z'
  };
  const codeToMonthMap = {
    'F': '01æœˆ', 'G': '02æœˆ', 'H': '03æœˆ', 'J': '04æœˆ',
    'K': '05æœˆ', 'M': '06æœˆ', 'N': '07æœˆ', 'Q': '08æœˆ',
    'U': '09æœˆ', 'V': '10æœˆ', 'X': '11æœˆ', 'Z': '12æœˆ'
  };

  const ALL_MONTHS = [
    '01æœˆ','02æœˆ','03æœˆ','04æœˆ','05æœˆ','06æœˆ',
    '07æœˆ','08æœˆ','09æœˆ','10æœˆ','11æœˆ','12æœˆ'
  ];

  function getCycleMonths() {
    return currentCycleMonths.length ? currentCycleMonths : ALL_MONTHS;
  }

  cycleSelect.addEventListener("change", function () {
    if (!isLoggedIn) {
      alert("è«‹å…ˆç™»å…¥");
      this.value = "";
      return;
    }

    container.innerHTML = "";
    if (!this.value) {
      currentCycleMonths = [];
      return;
    }

    const months = this.value.split(",").map(m => m.trim());
    currentCycleMonths = months;

    months.forEach(m => createRow(m));
  });

  // ========== ç”¢ç”Ÿä¸€åˆ— ==========
  function createRow(monthText) {
    const row = document.createElement("div");
    row.className = "rollover-row";

    // 1. æœˆä»½é¸å–® + +/- æ§åˆ¶
    const monthWrapper = document.createElement("div");
    monthWrapper.style.display = "flex";
    monthWrapper.style.alignItems = "center";
    monthWrapper.style.gap = "6px";

    const monthSelect = document.createElement("select");
    for (let i = 1; i <= 12; i++) {
      const m = i.toString().padStart(2, "0") + "æœˆ";
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      if (m === monthText) opt.selected = true;
      monthSelect.appendChild(opt);
    }

    function shiftMonth(delta) {
      const cycle = getCycleMonths();
      if (!cycle.length) return;

      const cur = monthSelect.value;
      let idx = cycle.indexOf(cur);
      if (idx === -1) {
        idx = 0;
      }

      let newIdx = (idx + delta + cycle.length) % cycle.length;
      monthSelect.value = cycle[newIdx];
    }

    const minusBtn = document.createElement("button");
    minusBtn.type = "button";
    minusBtn.className = "btn btn-outline btn-action";
    minusBtn.textContent = "âˆ’";
    minusBtn.title = "å‰ä¸€æœŸæœˆä»½";
    minusBtn.style.padding = "0 10px";
    minusBtn.onclick = () => shiftMonth(-1);

    const plusBtnMonth = document.createElement("button");
    plusBtnMonth.type = "button";
    plusBtnMonth.className = "btn btn-outline btn-action";
    plusBtnMonth.textContent = "+";
    plusBtnMonth.title = "å¾Œä¸€æœŸæœˆä»½";
    plusBtnMonth.style.padding = "0 10px";
    plusBtnMonth.onclick = () => shiftMonth(1);

    monthWrapper.appendChild(minusBtn);
    monthWrapper.appendChild(monthSelect);
    monthWrapper.appendChild(plusBtnMonth);
    row.appendChild(monthWrapper);

    // 2. æ—¥æœŸè¼¸å…¥
    const dateWrapper = document.createElement("div");
    const dateInput = document.createElement("input");
    dateInput.type = "date";
    dateWrapper.appendChild(dateInput);
    row.appendChild(dateWrapper);

    // 3. æ™‚é–“è¼¸å…¥
    const timeWrapper = document.createElement("div");
    const timeInput = document.createElement("input");
    timeInput.type = "time";
    timeInput.value = "22:19"; 
    timeWrapper.appendChild(timeInput);
    row.appendChild(timeWrapper);

    // 4. æ“ä½œæŒ‰éˆ•
    const actionWrapper = document.createElement("div");
    actionWrapper.style.display = "flex";
    actionWrapper.style.gap = "6px";

    const addBtn = document.createElement("button");
    addBtn.type = "button";
    addBtn.className = "btn btn-outline btn-action";
    addBtn.textContent = "+";
    addBtn.title = "åœ¨ä¸‹æ–¹æ’å…¥ä¸€åˆ—ï¼ˆåŒæœˆä»½ï¼‰";
    addBtn.onclick = () => {
      const newRow = createRow(monthSelect.value);
      container.insertBefore(newRow, row.nextSibling);
    };

    const delBtn = document.createElement("button");
    delBtn.type = "button";
    delBtn.className = "btn btn-danger btn-action";
    delBtn.textContent = "âœ•";
    delBtn.title = "åˆªé™¤æ­¤åˆ—";
    delBtn.onclick = () => container.removeChild(row);

    actionWrapper.appendChild(addBtn);
    actionWrapper.appendChild(delBtn);
    row.appendChild(actionWrapper);

    container.appendChild(row);
    return row;
  }

  // ========== å¾ç•«é¢è³‡æ–™å»ºæ§‹æ’ç¨‹ JSONï¼ˆä¸é€å‡ºï¼Œåªå›å‚³é™£åˆ—ï¼‰ ==========
  function buildScheduleData() {
    const rootSymbol = document.getElementById("symbol").value; 
    const year = parseInt(document.getElementById("yearSelect").value, 10);
    const yearDigit = year % 10;

    if (!rootSymbol) {
      alert("è«‹å…ˆé¸æ“‡å•†å“");
      return null;
    }

    const rows = Array.from(container.children);
    if (rows.length === 0) {
      alert("è«‹è¨­å®šè‡³å°‘ä¸€ç­†è³‡æ–™");
      return null;
    }

    const rowData = rows.map(row => {
      const monthSelect = row.querySelector("select");
      const dateInput   = row.querySelector('input[type="date"]');
      const timeInput   = row.querySelector('input[type="time"]');

      return {
        monthText: monthSelect ? monthSelect.value : null,
        dateVal: dateInput ? dateInput.value : "",
        timeVal: (timeInput && timeInput.value) ? timeInput.value : "22:19"
      };
    });

    const result = [];

    rowData.forEach((cur, index) => {
      if (!cur.monthText) return;
      if (!cur.dateVal) return;

      const monthCode = monthMap[cur.monthText];
      if (!monthCode) return;

      const oldReal = rootSymbol + monthCode + String(yearDigit);

      const nextIndex = (index + 1) % rowData.length;
      const next = rowData[nextIndex];

      if (!next.monthText) return;
      const newMonthCode = monthMap[next.monthText];
      if (!newMonthCode) return;

      let newYearDigit = yearDigit;
      if (nextIndex <= index) {
        newYearDigit = (year + 1) % 10;
      }

      const newReal = rootSymbol + newMonthCode + String(newYearDigit);

        // é€™ä¸€è¡Œæ”¹æ‰ï¼šç”¨ã€Œå°ç£æ™‚é–“ â†’ UTCã€è½‰æ›
        const scheduledAt = local0800ToUtc(cur.dateVal, cur.timeVal);

        result.push({
            old_real_symbol: oldReal,
            new_real_symbol: newReal,
            scheduled_at: scheduledAt
        });
    });

    if (!result.length) {
      alert("ç›®å‰è¨­å®šä¸­æ²’æœ‰æœ‰æ•ˆçš„è½‰å€‰è³‡æ–™ï¼ˆè«‹ç¢ºèªæ¯åˆ—éƒ½æœ‰æœˆä»½èˆ‡æ—¥æœŸï¼‰ã€‚");
      return null;
    }

    return result;
  }

  // ========== Modal é–‹é—œ ==========
  function openScheduleModal() {
    const symbolId = document.getElementById("symbolId").value;
    if (!symbolId) {
      alert("è«‹å…ˆé¸æ“‡å•†å“");
      return;
    }

    const schedules = buildScheduleData();
    if (!schedules || !schedules.length) return;

    currentBuiltSchedules = schedules;

    // çµ„é è¦½è¡¨æ ¼ï¼šå¹´ä»½ã€æœˆä»½ã€è½‰å€‰æ™‚é–“
    let html = `<table>
      <thead>
        <tr>
          <th>#</th>
          <th>å¹´ä»½</th>
          <th>æœˆä»½ (ç”± old_real_symbol è§£æ)</th>
          <th>old_real_symbol</th>
          <th>new_real_symbol</th>
          <th>è½‰å€‰æ™‚é–“</th>
        </tr>
      </thead>
      <tbody>`;

    schedules.forEach((item, idx) => {
      const yearText = parseYearFromOldRealSymbol(item.old_real_symbol);
      const monthText = parseMonthFromOldRealSymbol(item.old_real_symbol);
      const timeText = formatUtcDateTime(item.scheduled_at);

      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${yearText}</td>
          <td>${monthText}</td>
          <td>${item.old_real_symbol}</td>
          <td>${item.new_real_symbol}</td>
          <td>${timeText}</td>
        </tr>`;
    });

    html += `</tbody></table>`;
    schedulePreview.innerHTML = html;

    scheduleModal.classList.add("show");
  }

  function closeScheduleModal() {
    if (isSubmitting) return; // é€å‡ºä¸­é¿å…é—œé–‰
    scheduleModal.classList.remove("show");
  }

  // ========== é€å‡ºæ’ç¨‹ï¼šé€ç­†å‘¼å« APIï¼Œsleep 0.5 ç§’ ==========
  async function submitRollovers() {
    if (isSubmitting) return;
    const token = localStorage.getItem("str_access_token");
    const symbolId = document.getElementById("symbolId").value;
    const symbol = document.getElementById("symbol").value;

    if (!token) {
      alert("å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥");
      return;
    }
    if (!symbolId) {
      alert("è«‹å…ˆé¸æ“‡å•†å“");
      return;
    }
    if (!currentBuiltSchedules || !currentBuiltSchedules.length) {
      alert("ç›®å‰æ²’æœ‰å¯é€å‡ºçš„æ’ç¨‹ï¼Œè«‹å…ˆè¨­å®šè½‰å€‰æœˆä»½èˆ‡æ™‚é–“");
      return;
    }

    isSubmitting = true;
    submitLog.innerHTML = "";
    const url = `${ROLLOVER_API_BASE}/${symbolId}/rollovers`;

    for (let i = 0; i < currentBuiltSchedules.length; i++) {
      const payload = currentBuiltSchedules[i];
      try {
        const res = await axios.post(url, payload, {
          headers: { Authorization: `Bearer ${token}` }
        });

        submitLog.innerHTML += `<div>âœ… ç¬¬ ${i+1} ç­†ï¼š${payload.old_real_symbol} â†’ ${payload.new_real_symbol} é€å‡ºæˆåŠŸ</div>`;
      } catch (err) {
        console.error("Submit rollover error", err);
        const msg = err?.response?.data ? JSON.stringify(err.response.data) : err.message;
        submitLog.innerHTML += `<div>âŒ ç¬¬ ${i+1} ç­†ï¼š${payload.old_real_symbol} â†’ ${payload.new_real_symbol} é€å‡ºå¤±æ•—ï¼š${msg}</div>`;
      }

      await new Promise(r => setTimeout(r, 500)); // sleep 0.5 ç§’
    }

    isSubmitting = false;
    closeScheduleModal();

    // é‡æ–°è¼‰å…¥æ—¢æœ‰è½‰å€‰æ’ç¨‹
    if (symbolId) {
      loadExistingRollovers(symbolId, symbol);
    }
  }

  // ========== è¼”åŠ©è§£æ / æ ¼å¼åŒ– ==========
  function parseMonthFromOldRealSymbol(oldReal) {
    if (!oldReal || oldReal.length < 2) return "-";
    const len = oldReal.length;
    const monthCode = oldReal[len - 2];
    const yearDigit = oldReal[len - 1];
    const monthZh = codeToMonthMap[monthCode] || "";
    if (!monthZh) return `${monthCode}${yearDigit}`;
    return `${monthZh} (${oldReal})`;
  }

  function formatUtcDateTime(isoString) {
    if (!isoString) return "-";
    const d = new Date(isoString);
    if (isNaN(d.getTime())) return isoString;

    const local = new Date(d.getTime() + 8 * 60 * 60 * 1000);

    const y = local.getUTCFullYear();
    const m = String(local.getUTCMonth() + 1).padStart(2, "0");
    const day = String(local.getUTCDate()).padStart(2, "0");
    const hh = String(local.getUTCHours()).padStart(2, "0");
    const mm = String(local.getUTCMinutes()).padStart(2, "0");

    return `${y}-${m}-${day} ${hh}:${mm} (+0800)`;
  }

  function local0800ToUtc(dateStr, timeStr) {
    // é æœŸ dateStr = "2026-03-09", timeStr = "22:19"
    if (!dateStr || !timeStr) {
        return `${dateStr}T${timeStr}:00.000Z`;
    }

    // å¼·åˆ¶ç•¶æˆ +08:00 çš„æ™‚é–“
    const d = new Date(`${dateStr}T${timeStr}:00+08:00`);
    if (isNaN(d.getTime())) {
        // è½‰ä¸å‡ºä¾†å°±é€€å›åŸæœ¬æ ¼å¼ï¼Œé¿å…æ•´å€‹å£æ‰
        return `${dateStr}T${timeStr}:00.000Z`;
    }

    // toISOString() æœƒå›å‚³ UTC æ™‚é–“ï¼ˆçµå°¾å¸¶ Zï¼‰
    return d.toISOString();
    }

  function formatState(state) {
    if (state === 4) return "å®Œæˆ";
    if (state === 0) return "ç„¡";
    return String(state ?? "");
  }

  function parseYearFromOldRealSymbol(oldReal) {
    if (!oldReal || oldReal.length < 1) return "-";

    const yearDigit = parseInt(oldReal.slice(-1), 10);
    if (isNaN(yearDigit)) return "-";

    const currentYear = new Date().getFullYear();
    const currentDecade = Math.floor(currentYear / 10) * 10;

    let candidate = currentDecade + yearDigit;
    if (Math.abs(candidate - currentYear) > 5) {
      candidate -= 10;
    }

    return candidate;
  }

  // ========== è¼‰å…¥æ—¢æœ‰è½‰å€‰è¨­å®š ==========
  async function loadExistingRollovers(symbolId, symbol) {
    const token = localStorage.getItem("str_access_token");
    if (!token || !symbolId) {
      existingRollovers.textContent = "// å°šæœªç™»å…¥æˆ–å•†å“ ID ç„¡æ•ˆ";
      return;
    }

    existingRollovers.textContent = "è¼‰å…¥ä¸­â€¦";

    try {
      const url = `${ROLLOVER_API_BASE}/${symbolId}/rollovers`;
      const res = await axios.get(url, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.data?.error?.success) {
        existingRollovers.textContent = "è¼‰å…¥å¤±æ•—ï¼šAPI å›å‚³ success = false";
        return;
      }

      let list = res.data.result || [];
      if (!list.length) {
        existingRollovers.textContent = "æ­¤å•†å“ç›®å‰å°šç„¡æ—¢æœ‰è½‰å€‰æ’ç¨‹ã€‚";
        return;
      }

      list = [...list].sort((a, b) => {
        const da = new Date(a.scheduled_at);
        const db = new Date(b.scheduled_at);
        return db - da;
      });

      list = list.slice(0, 20);

      let html = `<table class="rollover-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>å¹´ä»½</th>
            <th>æœˆä»½ (ç”± old_real_symbol è§£æ)</th>
            <th>è½‰å€‰æ™‚é–“</th>
            <th>ç‹€æ…‹</th>
          </tr>
        </thead>
        <tbody>`;

      list.forEach(item => {
        const yearText = parseYearFromOldRealSymbol(item.old_real_symbol);
        const monthText = parseMonthFromOldRealSymbol(item.old_real_symbol);
        const timeText = formatUtcDateTime(item.scheduled_at);
        const stateText = formatState(item.state);

        html += `
          <tr>
            <td>${item.id}</td>
            <td>${yearText}</td>
            <td>${monthText}</td>
            <td>${timeText}</td>
            <td>${stateText}</td>
          </tr>`;
      });

      html += `</tbody></table>`;
      existingRollovers.innerHTML = html;
    } catch (err) {
      console.error("Load Existing Rollovers Error", err);
      existingRollovers.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    }
  }

</script>
</body>
</html>
